// å¤šè¯­è¨€é…ç½®
const i18n = {
    'zh-CN': {
        'nav.home': 'é¦–é¡µ', 'nav.features': 'åŠŸèƒ½', 'nav.faq': 'å¸¸è§é—®é¢˜',
        'title': 'æ™ºèƒ½å›¾ç‰‡è£å‰ªå·¥å…·',
        'subtitle': 'å…è´¹åœ¨çº¿æ™ºèƒ½å›¾ç‰‡è£å‰ªï¼Œæ”¯æŒæ‰¹é‡å¤„ç†å’Œå¤šç§æ ¼å¼å¯¼å‡º',
        'upload.text': 'ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„ä¸Šä¼ ',
        'btn.smartCrop': 'âš¡ æ™ºèƒ½è£å‰ª', 
        'btn.manualCrop': 'ğŸ– æ‰‹åŠ¨è£å‰ª', 
        'btn.reset': 'ğŸ”„ é‡ç½®', 
        'btn.downloadAll': 'ğŸ“¥ æ‰“åŒ…ä¸‹è½½',
        'loading': 'æ­£åœ¨æ™ºèƒ½è£å‰ª...',
        'results.title': 'è£å‰ªç»“æœ',
        'result.size': 'å°ºå¯¸:', 
        'btn.download': 'ä¸‹è½½', 
        'btn.delete': 'åˆ é™¤',
        'f.title.1': 'æ™ºèƒ½è¯†åˆ«', 'f.desc.1': 'æ— éœ€æ‰‹åŠ¨æ¡†é€‰ï¼Œè‡ªåŠ¨è¯†åˆ«ç´ æåŒºåŸŸ',
        'f.title.2': 'æ‰¹é‡å¤„ç†', 'f.desc.2': 'æ”¯æŒæ‰¹é‡ä¸Šä¼ å’Œå¯¼å‡ºï¼Œæ•ˆç‡å€å¢',
        'f.title.3': 'éšç§å®‰å…¨', 'f.desc.3': 'æ‰€æœ‰å¤„ç†åœ¨æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼Œä¸ä¸Šä¼ æœåŠ¡å™¨',
        'faq.title': 'å¸¸è§é—®é¢˜',
        'faq.q1': 'è¿™æ¬¾å›¾ç‰‡è£å‰ªå·¥å…·æ˜¯å¦å…è´¹ï¼Ÿ',
        'faq.a1': 'æ˜¯çš„ï¼Œæ™ºèƒ½å›¾ç‰‡è£å‰ªå·¥å…·æ˜¯å®Œå…¨å…è´¹çš„åœ¨çº¿å·¥å…·ï¼Œæ²¡æœ‰ä½¿ç”¨æ¬¡æ•°é™åˆ¶ï¼Œä¹Ÿä¸éœ€è¦æ³¨å†Œè´¦å·ã€‚',
        'faq.q2': 'æ”¯æŒå“ªäº›å›¾ç‰‡æ ¼å¼ï¼Ÿ',
        'faq.a2': 'æ”¯æŒ JPG, PNG, WebPæ ¼å¼çš„å›¾ç‰‡ï¼Œå¯¼å‡ºæ ¼å¼ä¸ºPNG',
        'faq.q3': 'å›¾ç‰‡ä¼šè¢«ä¸Šä¼ å—ï¼Ÿ',
        'faq.a3': 'ä¸ä¼šï¼Œæ‰€æœ‰å›¾ç‰‡å¤„ç†éƒ½åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­å®Œæˆï¼Œæ‚¨çš„å›¾ç‰‡ä¸ä¼šè¢«ä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ï¼Œä¿æŠ¤æ‚¨çš„éšç§å®‰å…¨ã€‚',
        'faq.q4': 'å¦‚æœæ™ºèƒ½è£å‰ªç»“æœä¸ç†æƒ³ï¼Œæˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ',
        'faq.a4': 'å¦‚æœæ™ºèƒ½è£å‰ªç»“æœä¸ç†æƒ³ï¼Œæ‚¨å¯ä»¥å°è¯•ä½¿ç”¨æ‰‹åŠ¨è£å‰ªåŠŸèƒ½ï¼Œæ‰‹åŠ¨è°ƒæ•´è£å‰ªåŒºåŸŸã€‚åŒæ—¶ï¼Œç¡®ä¿å›¾ç‰‡èƒŒæ™¯è‰²ä¸ç´ æé¢œè‰²æœ‰æ˜æ˜¾åŒºåˆ«ã€‚',
        'copyright': 'Â© 2025 æ™ºèƒ½å›¾ç‰‡è£å‰ªå·¥å…·. ä¿ç•™æ‰€æœ‰æƒåˆ©.',
        'alert.image': 'è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼'
    },
    'en': {
        'nav.home': 'Home', 'nav.features': 'Features', 'nav.faq': 'FAQ',
        'title': 'Smart Image Cropper',
        'subtitle': 'Free online AI cropping tool, supports batch processing',
        'upload.text': 'Click or drag image here to upload',
        'btn.smartCrop': 'âš¡ Smart Crop', 
        'btn.manualCrop': 'ğŸ– Manual Crop', 
        'btn.reset': 'ğŸ”„ Reset', 
        'btn.downloadAll': 'ğŸ“¥ Download All',
        'loading': 'Processing...',
        'results.title': 'Results',
        'result.size': 'Size:', 
        'btn.download': 'Download', 
        'btn.delete': 'Delete',
        'f.title.1': 'AI Detection', 'f.desc.1': 'Automatically detects and crops objects.',
        'f.title.2': 'Batch Mode', 'f.desc.2': 'Process multiple images at once.',
        'f.title.3': 'Privacy First', 'f.desc.3': 'Processing happens in your browser locally.',
        'faq.title': 'FAQ',
        'faq.q1': 'Is this image cropping tool free?',
        'faq.a1': 'Yes, Smart Image Cropper is a completely free online tool with no usage limits and no registration required.',
        'faq.q2': 'What image formats are supported?',
        'faq.a2': 'Supports JPG, PNG, and WebP formats; exports as PNG.',
        'faq.q3': 'Will images be uploaded?',
        'faq.a3': 'No, all processing is done locally in your browser. Images are not uploaded to any server, protecting your privacy.',
        'faq.q4': 'What if the smart crop result is not ideal?',
        'faq.a4': 'If the result is not ideal, try using the manual crop feature. Also, ensure there is a clear distinction between the background and the object.',
        'copyright': 'Â© 2025 Smart Image Cropper. All Rights Reserved.',
        'alert.image': 'Please upload an image file!'
    },
    'ja': {
        'nav.home': 'ãƒ›ãƒ¼ãƒ ', 'nav.features': 'æ©Ÿèƒ½', 'nav.faq': 'FAQ',
        'title': 'ã‚¹ãƒãƒ¼ãƒˆç”»åƒåˆ‡ã‚ŠæŠœã',
        'subtitle': 'AIè‡ªå‹•èªè­˜ã€ä¸€æ‹¬å‡¦ç†å¯¾å¿œã®ç„¡æ–™ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«',
        'upload.text': 'ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰',
        'btn.smartCrop': 'âš¡ AIåˆ‡ã‚ŠæŠœã', 
        'btn.manualCrop': 'ğŸ– æ‰‹å‹•åˆ‡ã‚ŠæŠœã', 
        'btn.reset': 'ğŸ”„ ãƒªã‚»ãƒƒãƒˆ', 
        'btn.downloadAll': 'ğŸ“¥ ä¸€æ‹¬DL',
        'loading': 'å‡¦ç†ä¸­...',
        'results.title': 'çµæœ',
        'result.size': 'ã‚µã‚¤ã‚º:', 
        'btn.download': 'DL', 
        'btn.delete': 'å‰Šé™¤',
        'f.title.1': 'AIèªè­˜', 'f.desc.1': 'ç´ æã‚’è‡ªå‹•èªè­˜ã—ã¦åˆ‡ã‚ŠæŠœãã¾ã™',
        'f.title.2': 'ä¸€æ‹¬å‡¦ç†', 'f.desc.2': 'è¤‡æ•°ã®ç”»åƒã‚’ä¸€åº¦ã«å‡¦ç†å¯èƒ½',
        'f.title.3': 'å®‰å…¨', 'f.desc.3': 'ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å‡¦ç†ã•ã‚Œã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã›ã‚“',
        'faq.q1': 'ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ç„¡æ–™ã§ã™ã‹ï¼Ÿ',
        'faq.a1': 'ã¯ã„ã€å®Œå…¨ç„¡æ–™ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚å›æ•°åˆ¶é™ã‚„ç™»éŒ²ã¯ä¸è¦ã§ã™ã€‚',
        'faq.q2': 'å¯¾å¿œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ï¼Ÿ',
        'faq.a2': 'JPGã€PNGã€WebPã«å¯¾å¿œã—ã¦ãŠã‚Šã€PNGã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚Œã¾ã™ã€‚',
        'faq.q3': 'ç”»åƒã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã‹ï¼Ÿ',
        'faq.a3': 'ã„ã„ãˆã€ã™ã¹ã¦ã®å‡¦ç†ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã§è¡Œã‚ã‚Œã¾ã™ã€‚ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¯ä¿è­·ã•ã‚Œã¾ã™ã€‚',
        'faq.q4': 'è‡ªå‹•åˆ‡ã‚ŠæŠœããŒã†ã¾ãã„ã‹ãªã„å ´åˆã¯ï¼Ÿ',
        'faq.a4': 'çµæœãŒç†æƒ³çš„ã§ãªã„å ´åˆã¯ã€æ‰‹å‹•åˆ‡ã‚ŠæŠœãã‚’è©¦ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€èƒŒæ™¯è‰²ã¨è¢«å†™ä½“ã®è‰²ãŒã¯ã£ãã‚ŠåŒºåˆ¥ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
        'copyright': 'Â© 2025 Smart Image Cropper. All Rights Reserved.',
        'alert.image': 'ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼'
    },
    'ko': {
        'nav.home': 'í™ˆ', 'nav.features': 'ê¸°ëŠ¥', 'nav.faq': 'FAQ',
        'title': 'ìŠ¤ë§ˆíŠ¸ ì´ë¯¸ì§€ ìë¥´ê¸°',
        'subtitle': 'ë¬´ë£Œ ì˜¨ë¼ì¸ AI ìë¥´ê¸° ë„êµ¬, ì¼ê´„ ì²˜ë¦¬ ì§€ì›',
        'upload.text': 'í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ',
        'btn.smartCrop': 'âš¡ ìŠ¤ë§ˆíŠ¸ ìë¥´ê¸°', 
        'btn.manualCrop': 'ğŸ– ìˆ˜ë™ ìë¥´ê¸°', 
        'btn.reset': 'ğŸ”„ ì´ˆê¸°í™”', 
        'btn.downloadAll': 'ğŸ“¥ ì „ì²´ ë‹¤ìš´ë¡œë“œ',
        'loading': 'ì²˜ë¦¬ ì¤‘...',
        'results.title': 'ê²°ê³¼',
        'result.size': 'í¬ê¸°:', 
        'btn.download': 'ë‹¤ìš´ë¡œë“œ', 
        'btn.delete': 'ì‚­ì œ',
        'f.title.1': 'AI ì¸ì‹', 'f.desc.1': 'ê°ì²´ë¥¼ ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³  ìë¦…ë‹ˆë‹¤.',
        'f.title.2': 'ì¼ê´„ ì²˜ë¦¬', 'f.desc.2': 'í•œ ë²ˆì— ì—¬ëŸ¬ ì´ë¯¸ì§€ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.',
        'f.title.3': 'ê°œì¸ ì •ë³´ ë³´í˜¸', 'f.desc.3': 'ëª¨ë“  ì²˜ë¦¬ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ë¡œì»¬ë¡œ ìˆ˜í–‰ë©ë‹ˆë‹¤.',
        'faq.title': 'ìì£¼ ë¬»ëŠ” ì§ˆë¬¸',
        'faq.q1': 'ë¬´ë£Œì¸ê°€ìš”?',
        'faq.a1': 'ë„¤, ì‚¬ìš© íšŸìˆ˜ ì œí•œì´ë‚˜ ê°€ì…ì´ í•„ìš” ì—†ëŠ” ì™„ì „ ë¬´ë£Œ ë„êµ¬ì…ë‹ˆë‹¤.',
        'faq.q2': 'ì§€ì› í˜•ì‹ì€?',
        'faq.a2': 'JPG, PNG, WebP í˜•ì‹ì„ ì§€ì›í•˜ë©° PNGë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.',
        'faq.q3': 'ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ë‚˜ìš”?',
        'faq.a3': 'ì•„ë‹ˆìš”, ëª¨ë“  ì²˜ë¦¬ëŠ” ë¡œì»¬ ë¸Œë¼ìš°ì €ì—ì„œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤. ê°œì¸ì •ë³´ê°€ ë³´í˜¸ë©ë‹ˆë‹¤.',
        'faq.q4': 'ìë™ ìë¥´ê¸° ê²°ê³¼ê°€ ì¢‹ì§€ ì•Šìœ¼ë©´ìš”?',
        'faq.a4': 'ê²°ê³¼ê°€ ë§Œì¡±ìŠ¤ëŸ½ì§€ ì•Šìœ¼ë©´ ìˆ˜ë™ ìë¥´ê¸° ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ ë³´ì„¸ìš”. ë°°ê²½ê³¼ í”¼ì‚¬ì²´ì˜ ìƒ‰ìƒ ì°¨ì´ê°€ ëª…í™•í•œì§€ í™•ì¸í•˜ì„¸ìš”.',
        'copyright': 'Â© 2025 Smart Image Cropper. All Rights Reserved.',
        'alert.image': 'ì´ë¯¸ì§€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!'
    }
};

let cropper = null;
let croppedImages = [];
let currentLang = 'zh-CN';

// è·¯å¾„æ˜ å°„
const langToPath = { 'zh-CN': '/zh', 'en': '/en', 'ja': '/ja', 'ko': '/ko' };
const pathToLang = { '/zh': 'zh-CN', '/en': 'en', '/ja': 'ja', '/ko': 'ko' };

document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    const cropBtn = document.getElementById('cropBtn');
    const manualCropBtn = document.getElementById('manualCropBtn');
    const resetBtn = document.getElementById('resetBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');

    // 1. åˆå§‹åŒ–å¤šè¯­è¨€
    initI18n();

    // 2. ä¸Šä¼ é€»è¾‘ (ä¿®å¤åŒé‡å¼¹çª—é—®é¢˜)
    uploadArea.addEventListener('click', function(e) {
        // åªæœ‰ç‚¹å‡»åŒºåŸŸæœ¬èº«æ‰è§¦å‘ inputï¼Œé¿å…å¦‚æœç‚¹åˆ°é‡Œé¢çš„å­å…ƒç´ è§¦å‘å†’æ³¡
        // ä½†ç”±äº fileInput æ˜¯ hidden çš„ï¼Œç›´æ¥ click å³å¯
        fileInput.click();
    });
    
    // é˜»æ­¢ input click å†’æ³¡ (é˜²æ­¢æ— é™å¾ªç¯ï¼Œè™½ç„¶ hidden ä¸å®¹æ˜“ç‚¹åˆ°)
    fileInput.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    // æ‹–æ‹½ä¸Šä¼ 
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#4f46e5';
        uploadArea.style.background = '#eef2ff';
    });
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = '';
        uploadArea.style.background = '';
    });
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '';
        uploadArea.style.background = '';
        if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
    });

    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) handleFile(this.files[0]);
    });

    // æŒ‰é’®äº‹ä»¶
    cropBtn.addEventListener('click', smartCrop);
    manualCropBtn.addEventListener('click', manualCrop);
    resetBtn.addEventListener('click', reset);
    downloadAllBtn.addEventListener('click', downloadAll);
});

// æ–‡ä»¶å¤„ç†å‡½æ•° (ä¿®å¤é¢„è§ˆæ¶ˆå¤±é—®é¢˜)
function handleFile(file) {
    if (!file.type.startsWith('image/')) {
        alert(i18n[currentLang]['alert.image']);
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const image = document.getElementById('image');
        image.src = e.target.result;
        
        // å¼ºåˆ¶æ˜¾ç¤ºé¢„è§ˆå®¹å™¨
        const previewContainer = document.getElementById('previewContainer');
        previewContainer.style.display = 'block'; 

        if (cropper) cropper.destroy();
        
        cropper = new Cropper(image, {
            viewMode: 1,
            autoCropArea: 1,
            responsive: true,
            background: false // ä¸æ˜¾ç¤ºç½‘æ ¼èƒŒæ™¯ï¼Œæ˜¾å¾—æ›´å¹²å‡€
        });

        // å¯ç”¨æŒ‰é’®
        document.getElementById('cropBtn').disabled = false;
        document.getElementById('manualCropBtn').disabled = false;
        document.getElementById('resetBtn').disabled = false;
        
        // éšè—ä¸Šä¼ æç¤ºï¼Œåªç•™å›¾
        document.querySelector('.upload-hint').style.display = 'none';
        document.querySelector('.upload-icon').style.display = 'none';
    };
    reader.readAsDataURL(file);
}

// ä»URLä¸­è·å–è¯­è¨€
function getLanguageFromURL() {
    const path = window.location.pathname;
    // å¤„ç†å¸¦æ–œæ çš„æƒ…å†µï¼Œå¦‚ /zh/
    const normalizedPath = path.endsWith('/') ? path.slice(0, -1) : path;
    
    if (pathToLang[normalizedPath]) {
        return pathToLang[normalizedPath];
    }
    
    // å¤„ç†æ›´å¤æ‚çš„è·¯å¾„ï¼Œå¦‚ /zh/some/path
    const firstSegment = normalizedPath.split('/')[1] || '';
    const langPath = '/' + firstSegment;
    if (pathToLang[langPath]) {
        return pathToLang[langPath];
    }
    
    return null;
}

// æ›´æ–°URL
function updateURL() {
    const path = langToPath[currentLang] || '';
    const url = window.location.origin + path + window.location.search + window.location.hash;
    history.pushState({ lang: currentLang }, '', url);
}

// åˆå§‹åŒ–å¤šè¯­è¨€
function initI18n() {
    // ä¼˜å…ˆä»URLè·å–è¯­è¨€
    const urlLang = getLanguageFromURL();
    if (urlLang && i18n[urlLang]) {
        currentLang = urlLang;
        document.getElementById('language').value = urlLang;
        localStorage.setItem('language', urlLang);
    } else {
        // ä»localStorageè·å–ä¸Šæ¬¡ä½¿ç”¨çš„è¯­è¨€
        const savedLang = localStorage.getItem('language');
        if (savedLang && i18n[savedLang]) {
            currentLang = savedLang;
            document.getElementById('language').value = savedLang;
        }
        // æ›´æ–°URLä¸ºå½“å‰è¯­è¨€
        updateURL();
    }
    
    // åº”ç”¨å¤šè¯­è¨€
    applyI18n();
}

// åº”ç”¨å¤šè¯­è¨€
function applyI18n() {
    const t = i18n[currentLang];
    if (!t) return;

    // è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨è®¾ç½®æ–‡æœ¬
    const setText = (selector, key) => {
        const el = document.querySelector(selector);
        if (el && t[key]) el.textContent = t[key];
    };

    // å¯¼èˆª
    setText('.nav-home', 'nav.home');
    setText('.nav-features', 'nav.features');
    setText('.nav-faq', 'nav.faq');

    // å¤´éƒ¨
    setText('.page-title', 'title');
    setText('.page-subtitle', 'subtitle');

    // ä¸Šä¼ 
    setText('.upload-hint', 'upload.text');

    // æŒ‰é’®
    const btns = {
        'cropBtn': 'btn.smartCrop',
        'manualCropBtn': 'btn.manualCrop',
        'resetBtn': 'btn.reset',
        'downloadAllBtn': 'btn.downloadAll'
    };
    for (let id in btns) {
        const btn = document.getElementById(id);
        if (btn) btn.textContent = t[btns[id]];
    }
    
    // ç»“æœæ ‡é¢˜
    setText('.results-title', 'results.title');
    
    // Loading
    setText('.loading-text', 'loading');

    // Features (ç”¨ç±»åå®šä½)
    setText('.f-title-1', 'f.title.1'); setText('.f-desc-1', 'f.desc.1');
    setText('.f-title-2', 'f.title.2'); setText('.f-desc-2', 'f.desc.2');
    setText('.f-title-3', 'f.title.3'); setText('.f-desc-3', 'f.desc.3');

    // FAQ
    setText('.faq-header', 'faq.title');
    
    setText('.q1', 'faq.q1'); 
    setText('.a1', 'faq.a1');
    
    setText('.q2', 'faq.q2'); 
    setText('.a2', 'faq.a2');
    
    setText('.q3', 'faq.q3'); 
    setText('.a3', 'faq.a3');
    
    // æ–°å¢çš„ç¬¬4ä¸ªé—®é¢˜
    setText('.q4', 'faq.q4'); 
    setText('.a4', 'faq.a4');

    // é¡µè„š
    setText('.copyright', 'copyright');
}

// åˆ‡æ¢è¯­è¨€
function changeLanguage() {
    const langSelect = document.getElementById('language');
    currentLang = langSelect.value;
    localStorage.setItem('language', currentLang);
    
    // æ›´æ–° URL (ä¸åˆ·æ–°)
    const path = langToPath[currentLang] || '/';
    window.history.replaceState(null, '', path);
    
    applyI18n();
}

// æ™ºèƒ½è£å‰ª
function smartCrop() {
    const loading = document.getElementById('loading');
    loading.style.display = 'inline-block';
    document.getElementById('cropBtn').disabled = true;
    document.getElementById('manualCropBtn').disabled = true;
    
    // è·å–å®Œæ•´çš„å›¾ç‰‡æ•°æ®
    const canvas = cropper.getCroppedCanvas();
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    
    // æ™ºèƒ½æ£€æµ‹ç´ æåŒºåŸŸ
    const regions = detectRange(imageData);
    
    // è£å‰ªæ¯ä¸ªç´ æ
    croppedImages = [];
    regions.forEach((region, index) => {
        const croppedCanvas = document.createElement('canvas');
        croppedCanvas.width = region.width;
        croppedCanvas.height = region.height;
        const croppedCtx = croppedCanvas.getContext('2d');
        
        // è£å‰ªå¹¶ç»˜åˆ¶åˆ°æ–°ç”»å¸ƒ
        croppedCtx.drawImage(canvas, region.x, region.y, region.width, region.height, 0, 0, region.width, region.height);
        
        const dataURL = croppedCanvas.toDataURL('image/png');
        croppedImages.push({
            id: index,
            dataURL: dataURL,
            width: region.width,
            height: region.height
        });
    });
    
    displayResults();
    loading.style.display = 'none';
    document.getElementById('cropBtn').disabled = false;
    document.getElementById('manualCropBtn').disabled = false;
    document.getElementById('downloadAllBtn').disabled = false;
}

// æ‰‹åŠ¨è£å‰ª
function manualCrop() {
    // è·å–ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©çš„è£å‰ªåŒºåŸŸ
    const croppedCanvas = cropper.getCroppedCanvas();
    
    // å°†è£å‰ªç»“æœè½¬æ¢ä¸ºdataURL
    const dataURL = croppedCanvas.toDataURL('image/png');
    
    // å°†è£å‰ªç»“æœæ·»åŠ åˆ°croppedImagesæ•°ç»„ä¸­
    croppedImages.push({
        id: croppedImages.length,
        dataURL: dataURL,
        width: croppedCanvas.width,
        height: croppedCanvas.height
    });
    
    // æ˜¾ç¤ºè£å‰ªç»“æœ
    displayResults();
    
    // ç¡®ä¿ä¸‹è½½æ‰€æœ‰æŒ‰é’®å˜ä¸ºå¯ç”¨çŠ¶æ€
    document.getElementById('downloadAllBtn').disabled = false;
}

// æ£€æµ‹ç´ æåŒºåŸŸçš„æ ¸å¿ƒç®—æ³•
function detectRange(imageData) {
    const { width, height, data } = imageData;
    
    // è·å–èƒŒæ™¯è‰²ï¼ˆä½¿ç”¨å·¦ä¸Šè§’åƒç´ ä½œä¸ºèƒŒæ™¯è‰²ï¼‰
    const bgR = data[0];
    const bgG = data[1];
    const bgB = data[2];
    const bgA = data[3];
    
    // åŸºäºç½‘æ ¼çš„èšç±»ï¼Œç½‘æ ¼å¤§å°ä¸º10åƒç´ 
    const gridSize = 10;
    const grid = {};
    
    // ç¬¬ä¸€æ­¥ï¼šå°†éèƒŒæ™¯åƒç´ åˆ†é…åˆ°ç½‘æ ¼ä¸­
    for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
            const index = (y * width + x) * 4;
            const r = data[index];
            const g = data[index + 1];
            const b = data[index + 2];
            const a = data[index + 3];
            
            // å¦‚æœä¸æ˜¯èƒŒæ™¯è‰²
            if (!isBackgroundColor(r, g, b, a, bgR, bgG, bgB, bgA)) {
                const gridX = Math.floor(x / gridSize);
                const gridY = Math.floor(y / gridSize);
                const gridKey = `${gridX},${gridY}`;
                
                if (!grid[gridKey]) {
                    grid[gridKey] = {
                        minX: x,
                        maxX: x,
                        minY: y,
                        maxY: y,
                        count: 0
                    };
                }
                
                const cell = grid[gridKey];
                cell.minX = Math.min(cell.minX, x);
                cell.maxX = Math.max(cell.maxX, x);
                cell.minY = Math.min(cell.minY, y);
                cell.maxY = Math.max(cell.maxY, y);
                cell.count++;
            }
        }
    }
    
    // ç¬¬äºŒæ­¥ï¼šåˆå¹¶ç›¸é‚»çš„éç©ºç½‘æ ¼
    const visitedGrids = new Set();
    const regions = [];
    
    // éå†æ‰€æœ‰éç©ºç½‘æ ¼
    Object.keys(grid).forEach(gridKey => {
        if (!visitedGrids.has(gridKey)) {
            // ä½¿ç”¨å¹¿åº¦ä¼˜å…ˆæœç´¢åˆå¹¶ç›¸é‚»ç½‘æ ¼
            const queue = [gridKey];
            visitedGrids.add(gridKey);
            
            let minX = Infinity;
            let maxX = -Infinity;
            let minY = Infinity;
            let maxY = -Infinity;
            
            while (queue.length > 0) {
                const currentKey = queue.shift();
                const currentGrid = grid[currentKey];
                
                // æ›´æ–°è¾¹ç•Œ
                minX = Math.min(minX, currentGrid.minX);
                maxX = Math.max(maxX, currentGrid.maxX);
                minY = Math.min(minY, currentGrid.minY);
                maxY = Math.max(maxY, currentGrid.maxY);
                
                // æ£€æŸ¥8ä¸ªç›¸é‚»ç½‘æ ¼
                const [gridX, gridY] = currentKey.split(',').map(Number);
                for (let dy = -1; dy <= 1; dy++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        if (dx === 0 && dy === 0) continue;
                        
                        const neighborKey = `${gridX + dx},${gridY + dy}`;
                        if (grid[neighborKey] && !visitedGrids.has(neighborKey)) {
                            visitedGrids.add(neighborKey);
                            queue.push(neighborKey);
                        }
                    }
                }
            }
            
            // ç”Ÿæˆè¾¹ç•Œæ¡†
            const region = {
                x: minX,
                y: minY,
                width: maxX - minX + 1,
                height: maxY - minY + 1
            };
            
            // è¿‡æ»¤æ‰å¤ªå°çš„åŒºåŸŸï¼ˆå¯èƒ½æ˜¯å™ªç‚¹ï¼‰
            if (region.width > 10 && region.height > 10) {
                regions.push(region);
            }
        }
    });
    
    return regions;
}

// åˆ¤æ–­æ˜¯å¦ä¸ºèƒŒæ™¯è‰²
function isBackgroundColor(r, g, b, a, bgR, bgG, bgB, bgA) {
    // é¢œè‰²ç›¸ä¼¼åº¦åˆ¤æ–­ï¼ˆå®¹å·®ä¸º20ï¼‰
    const colorDiff = Math.abs(r - bgR) + Math.abs(g - bgG) + Math.abs(b - bgB);
    return colorDiff < 60 && Math.abs(a - bgA) < 50;
}

// æ˜¾ç¤ºè£å‰ªç»“æœ
function displayResults() {
    const resultsSection = document.getElementById('resultsSection');
    const grid = document.getElementById('resultsGrid');
    
    // åªæœ‰å½“æœ‰å›¾ç‰‡æ—¶æ‰æ˜¾ç¤ºç»“æœåŒºåŸŸ
    if (croppedImages.length > 0) {
        resultsSection.style.display = 'block';
    } else {
        resultsSection.style.display = 'none';
        return;
    }
    
    grid.innerHTML = '';
    const lang = i18n[currentLang]; // è·å–å½“å‰è¯­è¨€åŒ…
    
    croppedImages.forEach((img, index) => {
        const div = document.createElement('div');
        div.className = 'result-item';
        
        // ä½¿ç”¨ innerHTML æ’å…¥å›¾ç‰‡ã€å°ºå¯¸ä¿¡æ¯ã€ä¸‹è½½æŒ‰é’®ã€åˆ é™¤æŒ‰é’®
        // æ³¨æ„ï¼šæŒ‰é’®ä½¿ç”¨äº†ä¸åŒçš„æ ·å¼ç±» (btn-primary, btn-outline) ä»¥åŒºåˆ†ä¸»æ¬¡
        div.innerHTML = `
            <img src="${img.dataURL}" alt="${lang['results.title']} ${index + 1}">
            <div style="font-size: 0.9em; color: #666; margin: 5px 0;">
                ${lang['result.size']} ${Math.round(img.width)}x${Math.round(img.height)}
            </div>
            <div style="display: flex; gap: 5px; margin-top: 5px;">
                <button class="btn btn-primary" style="flex:1; padding:6px; font-size:13px;" onclick="downloadImage(${index})">
                    ${lang['btn.download']}
                </button>
                <button class="btn btn-outline" style="padding:6px 12px; font-size:13px;" onclick="deleteImage(${index})">
                    ${lang['btn.delete']}
                </button>
            </div>
        `;
        
        grid.appendChild(div);
    });
}

// ä¸‹è½½å•ä¸ªå›¾ç‰‡
function downloadImage(index) {
    const img = croppedImages[index];
    const link = document.createElement('a');
    link.download = `cropped_${index + 1}.png`;
    link.href = img.dataURL;
    link.click();
}

// åˆ é™¤å•ä¸ªå›¾ç‰‡
function deleteImage(index) {
    croppedImages.splice(index, 1);
    displayResults();
    
    if (croppedImages.length === 0) {
        document.getElementById('downloadAllBtn').disabled = true;
    }
}

// æ‰“åŒ…ä¸‹è½½æ‰€æœ‰å›¾ç‰‡
function downloadAll() {
    if (croppedImages.length === 0) return;
    
    const zip = new JSZip();
    
    croppedImages.forEach((img, index) => {
        // å°† base64 è½¬æ¢ä¸º blob
        const base64Data = img.dataURL.split(',')[1];
        const blob = base64ToBlob(base64Data, 'image/png');
        zip.file(`cropped_${index + 1}.png`, blob);
    });
    
    zip.generateAsync({ type: 'blob' }).then(function(content) {
        saveAs(content, 'cropped_images.zip');
    });
}

// base64 è½¬ blob
function base64ToBlob(base64, mime) {
    const byteCharacters = atob(base64);
    const byteArrays = [];
    
    for (let offset = 0; offset < byteCharacters.length; offset += 512) {
        const slice = byteCharacters.slice(offset, offset + 512);
        const byteNumbers = new Array(slice.length);
        
        for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
        }
        
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
    }
    
    return new Blob(byteArrays, { type: mime });
}

// é‡ç½®
function reset() {
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    
    const image = document.getElementById('image');
    image.src = '';
    image.style.display = 'none';
    
    document.getElementById('cropBtn').disabled = true;
    document.getElementById('manualCropBtn').disabled = true;
    document.getElementById('resetBtn').disabled = true;
    document.getElementById('downloadAllBtn').disabled = true;
    
    clearResults();
    originalImage = null;
    croppedImages = [];
}

// æ¸…ç©ºç»“æœ
function clearResults() {
    const resultsGrid = document.getElementById('resultsGrid');
    resultsGrid.innerHTML = '';
    croppedImages = [];
    document.getElementById('downloadAllBtn').disabled = true;
}